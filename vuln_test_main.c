#include <ncurses.h>
#include <string.h>
#include <signal.h>
#include <stdlib.h>
#include "lib/phases.h" // also includes "tools_ncurses.h" and <unistd.h>
#include "lib/levels.h"

int start();
int index_m();
int level0();

int main() 
{
     WINDOW *m_start, *m_index;
     int maxy, maxx;
     int ch;
     int choice = 0;

     initscr();
     noecho();
     cbreak();
     curs_set(0);
     signal(SIGWINCH, NULL);
     keypad(stdscr, TRUE);
     
     getmaxyx(stdscr, maxy, maxx);

     box(stdscr, 0, 0);

     attron(A_REVERSE);
     mvprintw(LINES-1, 0, " Press (q) to exit ");
     attroff(A_REVERSE);
     attron(A_BOLD);
     mvprintw(2, 4, "Welcome to the learning program for simple software exploits.");
     mvprintw(4, 4, "If this is your first time using this program please select (start)");
     mvprintw(5, 4, "If you want to continue where you left off please select (index)");
     mvprintw(6, 4, "Use the arrow keys to select");
     attroff(A_BOLD);
     
     // This refresh() fucked me over so hard; don't forget to call it before creating a new window!!
     refresh(); 

     m_start = create_newwin(5, 9, (LINES-8), (maxx/2)-21);
     m_index = create_newwin(5, 9, (LINES-8), (maxx/2)+12);

     mvwprintw(m_start, 2, 2, "start");
     mvwprintw(m_index, 2, 2, "index");
     wrefresh(m_start);
     wrefresh(m_index);

     while((ch = getch()) != 'q') {
          if(ch == '\n' && choice != 0) {
               if(choice == 1) {
                    start();     
               }
               else if(choice == 2) {
                    index_m();
               }
          }
          // START highlighted
          else if(ch == KEY_LEFT) {
               wattron(m_start, A_REVERSE);
               mvwprintw(m_start, 2, 2, "start");
               wattroff(m_start, A_REVERSE);

               wattron(m_index, A_NORMAL);
               mvwprintw(m_index, 2, 2, "index");
               wattroff(m_index, A_NORMAL);

               wrefresh(m_start);
               wrefresh(m_index);
               choice = 1;
          }
          // INDEX highlighted
          else if(ch == KEY_RIGHT) {
               wattron(m_start, A_NORMAL);
               mvwprintw(m_start, 2, 2, "start");
               wattroff(m_start, A_NORMAL);

               wattron(m_index, A_REVERSE);
               mvwprintw(m_index, 2, 2, "index");
               wattroff(m_index, A_REVERSE);
               
               wrefresh(m_index);
               wrefresh(m_start);
               choice = 2;
          }
     }

     endwin();
     return 0;
}

int start() 
{

     int ch;

     phase_1();

     while ((ch = getch()) != '\n') {
          phase_1();
     }

     phase_2();

     while ((ch = getch()) != '\n') {
          phase_2();
     }

     level0();

     return 0;

}

int index_m()
{
     clear();
     box(stdscr, 0, 0);

     return 0;
}
